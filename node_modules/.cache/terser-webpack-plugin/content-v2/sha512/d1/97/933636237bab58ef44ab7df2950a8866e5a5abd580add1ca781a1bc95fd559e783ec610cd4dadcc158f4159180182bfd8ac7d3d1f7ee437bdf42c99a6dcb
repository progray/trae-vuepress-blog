{"code":"(window.webpackJsonp=window.webpackJsonp||[]).push([[175],{759:function(s,t,a){\"use strict\";a.r(t);var n=a(10),e=Object(n.a)({},(function(){var s=this,t=s.$createElement,a=s._self._c||t;return a(\"ContentSlotsDistributor\",{attrs:{\"slot-key\":s.$parent.slotKey}},[a(\"p\",[s._v(\"Dify服务已经跑了一年多，中间也跟着版本更新折腾过几轮。但最近一段时间业务比较稳，我就没怎么盯它了。\")]),s._v(\" \"),a(\"p\",[s._v(\"直到前两天，腾讯云一条短信告警把我叫醒：CPU 占用率持续飙高。我上去看了一眼，Dify 这套部署明显不对劲。\")]),s._v(\" \"),a(\"p\",[s._v(\"直觉告诉我：\"),a(\"strong\",[s._v(\"坏了，我不当“矿主”，但我可能成“矿机”了。\")])]),s._v(\" \"),a(\"p\",[s._v(\"后面就是一番惊心动魄（其实是熬夜掉发）的排查：从日志到容器文件，再到进程和外联，最终把一个潜伏了快两周的“幽灵”揪了出来——而且还和最近挺火的 Next.js RCE 漏洞有关。想着独乐乐不如众乐乐，干脆把这次排查过程记下来，给各位还在裸奔 Next.js 服务的朋友提个醒。\")]),s._v(\" \"),a(\"h2\",{attrs:{id:\"_0x01-案发现场-这一堆-js-是个啥\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_0x01-案发现场-这一堆-js-是个啥\"}},[s._v(\"#\")]),s._v(\" 0x01 案发现场：这一堆 JS 是个啥？\")]),s._v(\" \"),a(\"p\",[s._v(\"连上服务器，直接定位到 \"),a(\"code\",[s._v(\"dify-web\")]),s._v(\" 容器。\")]),s._v(\" \"),a(\"p\",[s._v(\"通常来说，Next.js 的配置文件 \"),a(\"code\",[s._v(\"next.config.js\")]),s._v(\" 长得都很眉清目秀，配置一下 headers，弄一下 rewrites，撑死几十行。\")]),s._v(\" \"),a(\"p\",[s._v(\"但我打开我的 \"),a(\"code\",[s._v(\"next.config.js\")]),s._v(\" 一看，好家伙，直接瞎眼：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-javascript line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-javascript\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// next.config.js (被黑客魔改版)\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"...\")]),s._v(\"一大堆乱码\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"...\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"eval\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"new\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token class-name\"}},[s._v(\"Buffer\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"...base64字符串...\"')]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"toString\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"...\")]),s._v(\"\\n\")])]),s._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),a(\"br\")])]),a(\"p\",[s._v(\"这要是能是官方代码，我当场把键盘吃下去。这明显是被注入了混淆后的恶意代码。\")]),s._v(\" \"),a(\"p\",[s._v(\"再在容器里逛逛，发现 \"),a(\"code\",[s._v(\"/app/web/\")]),s._v(\" 目录下多了一堆不速之客：\")]),s._v(\" \"),a(\"ul\",[a(\"li\",[a(\"code\",[s._v(\"watcher.js\")])]),s._v(\" \"),a(\"li\",[a(\"code\",[s._v(\"guard.js\")])]),s._v(\" \"),a(\"li\",[a(\"code\",[s._v(\"proc.js\")])]),s._v(\" \"),a(\"li\",[a(\"code\",[s._v(\"config.js\")]),s._v(\" (这个不是真的配置文件)\")])]),s._v(\" \"),a(\"p\",[s._v('看名字就知道，这帮人还挺讲究\"服务质量\"。'),a(\"code\",[s._v(\"watcher\")]),s._v(\" 和 \"),a(\"code\",[s._v(\"guard\")]),s._v(' 明显是用来做持久化的——你杀我进程，我拉起；你删我文件，我恢复。主打一个\"死皮赖脸\"。')]),s._v(\" \"),a(\"p\",[s._v(\"打开 \"),a(\"code\",[s._v(\"watcher.js\")]),s._v(\" 瞄了一眼：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-javascript line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-javascript\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// watcher.js (simplified)\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"const\")]),s._v(\" config \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"require\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v(\"'./config'\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"const\")]),s._v(\" proc \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"require\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v(\"'./proc'\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"async\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=>\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"while\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token boolean\"}},[s._v(\"true\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"const\")]),s._v(\" status \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" proc\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"checkProcessStatus\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"config\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"processName\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" config\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"walletID\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"if\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"status \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"!==\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"1\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\"\\n            proc\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"startProcess\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"config\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"binaryPath\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" config\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"launchArgs\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n        \"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"await\")]),s._v(\" utils\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"sleep\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token number\"}},[s._v(\"10000\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"  \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// check every 10s\")]),s._v(\"\\n    \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\")])]),s._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"7\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"8\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"9\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"10\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"11\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"12\")]),a(\"br\")])]),a(\"p\",[s._v(\"每 10 秒检查一次挖矿进程是否存活，死了就拉起。这守护逻辑写得还挺工整，难怪手动杀进程根本没用。\")]),s._v(\" \"),a(\"p\",[s._v(\"进程列表里，两个 \"),a(\"code\",[s._v(\"xmrig\")]),s._v(\" 进程正跑得欢。还发现了一个反弹 shell 连接到 \"),a(\"code\",[s._v(\"47.109.188.82:4444\")]),s._v(\"。这是典型的挖矿 + 远控组合拳。\")]),s._v(\" \"),a(\"h2\",{attrs:{id:\"_0x02-溯源-他是怎么进来的\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_0x02-溯源-他是怎么进来的\"}},[s._v(\"#\")]),s._v(\" 0x02 溯源：他是怎么进来的？\")]),s._v(\" \"),a(\"p\",[s._v(\"这是最让我头疼的问题。我的密码强度还行，SSH也没对外开放，Docker 端口也没裸奔。那问题肯定出在应用层。\")]),s._v(\" \"),a(\"p\",[s._v(\"去翻了翻 Nginx 日志和容器日志，把时间线拉回到 \"),a(\"strong\",[s._v(\"2025年12月5日\")]),s._v(\"。\")]),s._v(\" \"),a(\"p\",[s._v(\"在下午 14:35 左右，日志里出现了一个熟悉的 User-Agent：\"),a(\"code\",[s._v(\"Assetnote/1.0.0\")]),s._v(\"。懂行的都知道，这是著名的自动化扫描工具。看来我的站早就被“贼”惦记上了。\")]),s._v(\" \"),a(\"p\",[s._v(\"然后在 \"),a(\"strong\",[s._v(\"18:23\")]),s._v(\"，关键的一行日志出现了：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language- line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[a(\"code\",[s._v(\"GET /exec?cmd=...\\n\")])]),s._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),a(\"br\")])]),a(\"p\",[s._v(\"紧接着 \"),a(\"code\",[s._v(\"/exec\")]),s._v(\" 后门不断被利用，攻击者开始部署挖矿程序和持久化脚本。\")]),s._v(\" \"),a(\"p\",[s._v(\"这看起来像是一个未授权的 RCE（远程代码执行）后门。但我此时还没搞懂这个后门是怎么被插进来的。\")]),s._v(\" \"),a(\"p\",[s._v(\"直到我看到了一些奇怪的报错日志：\")]),s._v(\" \"),a(\"div\",{staticClass:\"language- line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[a(\"code\",[s._v(\"[Error: Command failed: ls / -alhSt / | base64-w 0]\\n[TypeError: Failed to parse body as FormData.]\\n\")])]),s._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),a(\"br\")])]),a(\"p\",[s._v(\"结合 Next.js 的版本（15.2.3）和 React 版本（19.0.0），破案了。这是 \"),a(\"strong\",[s._v(\"CVE-2025-55182\")]),s._v(\"，一个针对 \"),a(\"strong\",[s._v(\"Next.js React Server Components (RSC)\")]),s._v(\" 的 RCE 漏洞。\")]),s._v(\" \"),a(\"p\",[s._v(\"攻击者利用这个漏洞，在我的服务器上执行了 \"),a(\"code\",[s._v(\"ls\")]),s._v(\" 命令探路，然后利用 \"),a(\"code\",[s._v(\"eval()\")]),s._v(\" 和 \"),a(\"code\",[s._v(\"new Function()\")]),s._v(\" 把我的 \"),a(\"code\",[s._v(\"next.config.js\")]),s._v(\" 替换成了他的后门加载器。\")]),s._v(\" \"),a(\"p\",[s._v(\"整个过程行云流水，从扫描到植入后门，前后不到4小时。这年头的黑客，效率比我写Bug都高。\")]),s._v(\" \"),a(\"h2\",{attrs:{id:\"_0x03-攻击链路-完整的攻击时间线\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_0x03-攻击链路-完整的攻击时间线\"}},[s._v(\"#\")]),s._v(\" 0x03 攻击链路：完整的攻击时间线\")]),s._v(\" \"),a(\"p\",[s._v(\"把所有日志碎片拼起来后，还原出了攻击者的完整作案流程。大家可以感受一下这个节奏：\")]),s._v(\" \"),a(\"ul\",[a(\"li\",[a(\"p\",[a(\"strong\",[s._v(\"2025-12-05 14:35 (探测期)\")]),s._v(\"\\n攻击者 IP \"),a(\"code\",[s._v(\"152.32.192.172\")]),s._v(\" 首次出现，User-Agent 还是 \"),a(\"code\",[s._v(\"Assetnote\")]),s._v(\" 扫描器，正在漫无目的地扫我的端口和路径。\")])]),s._v(\" \"),a(\"li\",[a(\"p\",[a(\"strong\",[s._v(\"2025-12-05 15:35 - 17:00 (武器化)\")]),s._v(\"\\n针对 CVE-2025-55182 的专用扫描器开始活动，尝试探测 RSC 接口。\")])]),s._v(\" \"),a(\"li\",[a(\"p\",[a(\"strong\",[s._v(\"2025-12-05 18:23 (突破点)\")]),s._v(\" \"),a(\"strong\",[s._v(\"首次利用成功\")]),s._v(\"。日志显示 \"),a(\"code\",[s._v(\"/exec?cmd=\")]),s._v(\" 后门第一次返回 200 OK。这意味着我的 \"),a(\"code\",[s._v(\"next.config.js\")]),s._v(\" 在这一刻之前已经被篡改完成了。\")])]),s._v(\" \"),a(\"li\",[a(\"p\",[a(\"strong\",[s._v(\"2025-12-05 18:46 - 21:00 (驻留)\")]),s._v(\"\\n后门被频繁访问，攻击者开始上传他的工具包。\")])]),s._v(\" \"),a(\"li\",[a(\"p\",[a(\"strong\",[s._v(\"2025-12-05 晚间 (变现)\")]),s._v(\"\\n挖矿程序 \"),a(\"code\",[s._v(\"xmrig\")]),s._v(\" 启动，CPU 占用率开始飙升。同时部署守护脚本 \"),a(\"code\",[s._v(\"watcher.js\")]),s._v(\"。\")])]),s._v(\" \"),a(\"li\",[a(\"p\",[a(\"strong\",[s._v(\"2025-12-06 (控制)\")]),s._v(\"\\n建立反弹 shell (\"),a(\"code\",[s._v(\"nc\")]),s._v(\" -> \"),a(\"code\",[s._v(\"47.109.188.82\")]),s._v(\")，正式获得交互式控制权。\")])]),s._v(\" \"),a(\"li\",[a(\"p\",[a(\"strong\",[s._v(\"2025-12-10 (窃取)\")]),s._v(\"\\n投放数据窃取脚本 \"),a(\"code\",[s._v(\"scan_68044064.js\")]),s._v(\"，尝试打包我的敏感文件。\")])]),s._v(\" \"),a(\"li\",[a(\"p\",[a(\"strong\",[s._v(\"2025-12-16 (发现)\")]),s._v(\"\\n腾讯云告警触发，介入排查。\")])])]),s._v(\" \"),a(\"h2\",{attrs:{id:\"_0x04-黑客的-全家桶\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_0x04-黑客的-全家桶\"}},[s._v(\"#\")]),s._v(' 0x04 黑客的\"全家桶\"')]),s._v(\" \"),a(\"p\",[s._v(\"深入分析了一下黑客留下的脚本，发现这哥们儿野心不小。\")]),s._v(\" \"),a(\"ol\",[a(\"li\",[a(\"p\",[a(\"strong\",[s._v(\"挖矿\")]),s._v(\"：这是基本操作。连接 \"),a(\"code\",[s._v(\"auto.c3pool.org\")]),s._v(\" 和 \"),a(\"code\",[s._v(\"pool.hashvault.pro\")]),s._v(\"，用我的CPU资源给他赚 XMR。\")])]),s._v(\" \"),a(\"li\",[a(\"p\",[a(\"strong\",[s._v(\"持久化\")]),s._v(\"：\")]),s._v(\" \"),a(\"ul\",[a(\"li\",[s._v(\"修改了 Next.js 的内部库，确保持久化脚本在应用启动时自动加载。\")]),s._v(\" \"),a(\"li\",[a(\"code\",[s._v(\"watcher.js\")]),s._v(\" 负责监控，一旦发现挖矿进程被杀，立马重启。\")])])]),s._v(\" \"),a(\"li\",[a(\"p\",[a(\"strong\",[s._v(\"数据窃取\")]),s._v(\"（Data Exfiltration）：\\n我在 \"),a(\"code\",[s._v(\"/tmp\")]),s._v(\" 目录下发现了一个叫 \"),a(\"code\",[s._v(\"scan_68044064.js\")]),s._v(\" 的脚本。打开一看，心里一凉。\")]),s._v(\" \"),a(\"p\",[s._v(\"这脚本专门用来扫描服务器上的敏感文件：\")]),s._v(\" \"),a(\"ul\",[a(\"li\",[a(\"code\",[s._v(\"wallet.json\")]),s._v(\"（钱包文件）\")]),s._v(\" \"),a(\"li\",[a(\"code\",[s._v(\"id_rsa\")]),s._v(\"（SSH 私钥）\")]),s._v(\" \"),a(\"li\",[s._v(\"AWS Key、API Key\")]),s._v(\" \"),a(\"li\",[a(\"code\",[s._v(\".env\")]),s._v(\" 里的环境变量\")])]),s._v(\" \"),a(\"p\",[s._v(\"好消息是，根据日志看，这个脚本似乎执行失败了或者没传输出去。坏消息是，这说明黑客不仅仅满足于挖矿，他还要偷我家。\")])])]),s._v(\" \"),a(\"h2\",{attrs:{id:\"_0x05-止损与反思\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_0x05-止损与反思\"}},[s._v(\"#\")]),s._v(\" 0x05 止损与反思\")]),s._v(\" \"),a(\"p\",[s._v(\"既然查清楚了，那就动手吧。\")]),s._v(\" \"),a(\"ol\",[a(\"li\",[a(\"p\",[a(\"strong\",[s._v(\"杀进程？删文件？没用的。\")]),s._v(\"\\n人家有守护进程，还有内存驻留。最干净的办法是——\"),a(\"strong\",[s._v(\"重建容器\")]),s._v(\"。\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[s._v(\"docker stop dify-web\\ndocker \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"rm\")]),s._v(\" dify-web\\n\")])]),s._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),a(\"br\")])]),a(\"p\",[s._v(\"直接把被污染的容器扬了。\")])]),s._v(\" \"),a(\"li\",[a(\"p\",[a(\"strong\",[s._v(\"封锁 IP\")]),s._v(\"\\n在Nginx和防火墙层面，把 \"),a(\"code\",[s._v(\"152.32.192.172\")]),s._v(\" 这个主犯 IP 给 ban 了。顺手把 \"),a(\"code\",[s._v(\"/exec\")]),s._v(\" 这种明显不该暴露的路径也给 deny 掉。\")])]),s._v(\" \"),a(\"li\",[a(\"p\",[a(\"strong\",[s._v(\"升级 Next.js\")]),s._v(\"\\n这是根本。CVE-2025-55182 是个高危漏洞，必须把 Next.js 升级到安全版本。对应的 \"),a(\"code\",[s._v(\"package.json\")]),s._v(\" 改起来，重新 build 镜像。\")])])]),s._v(\" \"),a(\"h2\",{attrs:{id:\"_0x60-总结\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_0x60-总结\"}},[s._v(\"#\")]),s._v(\" 0x60 总结\")]),s._v(\" \"),a(\"p\",[s._v(\"这次“被挖矿”的经历，严格来说没让我直接“破产”，但最恶心的是：你要是不主动去看，它能悄悄跑很久——直到有一天短信把你吵醒，直到腾讯把你的账户给封了（冤>:<）。\")]),s._v(\" \"),a(\"h3\",{attrs:{id:\"_1-告警触发后的第一眼-进程不对劲\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_1-告警触发后的第一眼-进程不对劲\"}},[s._v(\"#\")]),s._v(\" 1) 告警触发后的第一眼：进程不对劲\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"# on-host\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"top\")]),s._v(\" -c\\n\")])]),s._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),a(\"br\")])]),a(\"div\",{staticClass:\"language-text line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[a(\"code\",[s._v(\"PID   USER   COMMAND                          %CPU  %MEM\\n...   1001   /tmp/xmrig -o auto.c3pool.org...  320   2.1\\n...   1001   /tmp/xmrig -o pool.hashvault.pro  310   2.0\\n\")])]),s._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),a(\"br\")])]),a(\"h3\",{attrs:{id:\"_2-容器里多出来的-全家桶\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_2-容器里多出来的-全家桶\"}},[s._v(\"#\")]),s._v(' 2) 容器里多出来的\"全家桶\"')]),s._v(\" \"),a(\"div\",{staticClass:\"language-bash line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-bash\"}},[a(\"code\",[s._v(\"docker \"),a(\"span\",{pre:!0,attrs:{class:\"token builtin class-name\"}},[s._v(\"exec\")]),s._v(\" -it dify-web \"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"sh\")]),s._v(\" -c \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v(\"'ls -alh /app/web/xmrig-6.24.0/'\")]),s._v(\"\\n\")])]),s._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),a(\"br\")])]),a(\"div\",{staticClass:\"language-text line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[a(\"code\",[s._v(\"total 8164\\n-rwxr-xr-x  1 1001  root  8334576 Jun 23 00:46 xmrig\\n-rw-r--r--  1 1001  root     2348 Jun 23 00:46 config.json\\n-rw-r--r--  1 1001  root      150 Jun 23 00:46 SHA256SUMS\\n\")])]),s._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),a(\"br\")])]),a(\"p\",[s._v(\"完整的 xmrig 挖矿套件，连配置文件和哈希校验都带上了。专业得让人心寒。\")]),s._v(\" \"),a(\"h3\",{attrs:{id:\"_3-最关键的一锤-next-config-js-明显被人动过手脚\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_3-最关键的一锤-next-config-js-明显被人动过手脚\"}},[s._v(\"#\")]),s._v(\" 3) 最关键的一锤：\"),a(\"code\",[s._v(\"next.config.js\")]),s._v(\" 明显被人动过手脚\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-javascript line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-javascript\"}},[a(\"code\",[a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// next.config.js (redacted)\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// NOTE: This is malicious style. Do not copy into any project.\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"const\")]),s._v(\" s \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"ZXZhbChuZXcgRnVuY3Rpb24oLi4uKSk=\"')]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// base64\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token keyword\"}},[s._v(\"const\")]),s._v(\" p \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" Buffer\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"from\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"s\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\",\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token string\"}},[s._v('\"base64\"')]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"toString\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\"),a(\"span\",{pre:!0,attrs:{class:\"token function\"}},[s._v(\"eval\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"(\")]),s._v(\"p\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\")\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"// classic red flag\")]),s._v(\"\\nmodule\"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\".\")]),s._v(\"exports \"),a(\"span\",{pre:!0,attrs:{class:\"token operator\"}},[s._v(\"=\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"{\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token comment\"}},[s._v(\"/* ... pretend to be normal config ... */\")]),s._v(\" \"),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\"}\")]),a(\"span\",{pre:!0,attrs:{class:\"token punctuation\"}},[s._v(\";\")]),s._v(\"\\n\")])]),s._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"4\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"5\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"6\")]),a(\"br\")])]),a(\"p\",[s._v(\"上面这种“把执行逻辑藏在配置文件里”的玩法，本质就是：\"),a(\"strong\",[s._v(\"你以为你在跑 Next.js，其实你在帮人跑 payload\")]),s._v(\"。\")]),s._v(\" \"),a(\"h3\",{attrs:{id:\"_4-访问日志的味道-先扫描、再打点、再利用\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_4-访问日志的味道-先扫描、再打点、再利用\"}},[s._v(\"#\")]),s._v(\" 4) 访问日志的味道：先扫描、再打点、再利用\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-text line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[a(\"code\",[s._v('# nginx access (real logs, redacted)\\n152.32.192.172 - - [05/Dec/2025:14:35:17 +0800] \"HEAD /apps HTTP/1.1\" 200 0 \"-\" \"python-requests/2.32.4\"\\n152.32.192.172 - - [05/Dec/2025:18:23:56 +0800] \"GET /exec?cmd=echo+RaidEnMei%7Cxargs HTTP/2.0\" 200 64 \"-\" \"Mozilla/5.0 (compatible; StressTest/1.0)\"\\n')])]),s._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"3\")]),a(\"br\")])]),a(\"p\",[s._v(\"从探测到利用，攻击者步步为营。更关键的是，这些请求全部返回 \"),a(\"strong\",[s._v(\"200 OK\")]),s._v(\"，说明后门已经在正常响应。\")]),s._v(\" \"),a(\"h3\",{attrs:{id:\"_5-网络连接-反弹-shell-的铁证\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_5-网络连接-反弹-shell-的铁证\"}},[s._v(\"#\")]),s._v(\" 5) 网络连接：反弹 shell 的铁证\")]),s._v(\" \"),a(\"div\",{staticClass:\"language-text line-numbers-mode\"},[a(\"pre\",{pre:!0,attrs:{class:\"language-text\"}},[a(\"code\",[s._v(\"# netstat output from dify-web container\\ntcp  0  0  172.22.0.7:35589  47.109.188.82:4444  ESTABLISHED  258/nc\\n\")])]),s._v(\" \"),a(\"div\",{staticClass:\"line-numbers-wrapper\"},[a(\"span\",{staticClass:\"line-number\"},[s._v(\"1\")]),a(\"br\"),a(\"span\",{staticClass:\"line-number\"},[s._v(\"2\")]),a(\"br\")])]),a(\"p\",[a(\"code\",[s._v(\"nc\")]),s._v(\" 进程直连攻击者 C2，这不只是挖矿，攻击者已经拿到了容器的交互式 shell。\")]),s._v(\" \"),a(\"h3\",{attrs:{id:\"_6-这次让我最不舒服的点-他们不只想挖矿\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#_6-这次让我最不舒服的点-他们不只想挖矿\"}},[s._v(\"#\")]),s._v(\" 6) 这次让我最不舒服的点：他们不只想挖矿\")]),s._v(\" \"),a(\"p\",[s._v(\"我在 \"),a(\"code\",[s._v(\"/tmp\")]),s._v(\" 里看到的数据窃取脚本，目标非常“现实”：\"),a(\"code\",[s._v(\".env\")]),s._v(\"、私钥、token、云凭证……\"),a(\"br\"),s._v(\"\\n哪怕最终没证据证明外带成功，\"),a(\"strong\",[s._v(\"光是出现这个脚本就足够让我把“可能泄露”当成真事来处理\")]),s._v(\"（轮转密钥、排查访问、做全量审计）。\")]),s._v(\" \"),a(\"h3\",{attrs:{id:\"最后的建议\"}},[a(\"a\",{staticClass:\"header-anchor\",attrs:{href:\"#最后的建议\"}},[s._v(\"#\")]),s._v(\" 最后的建议\")]),s._v(\" \"),a(\"ol\",[a(\"li\",[a(\"strong\",[s._v(\"别只盯 CPU\")]),s._v(\"：同时看外联（异常目的 IP/域名/端口）、容器文件变更（\"),a(\"code\",[s._v(\"docker diff\")]),s._v(\"）、以及应用日志（很多 RCE 线索不在 Nginx 状态码里）。\")]),s._v(\" \"),a(\"li\",[a(\"strong\",[s._v(\"升级要快\")]),s._v(\"：这类热点 CVE 的“武器化速度”非常离谱，拖一周就是给人送窗口期。\")]),s._v(\" \"),a(\"li\",[a(\"strong\",[s._v('防守要\"土\"一点')]),s._v(\"：把 \"),a(\"code\",[s._v(\"/exec\")]),s._v(\" 这种明显不该暴露的路径直接 403；再加上最基本的 IP/UA 限制，能挡掉不少自动化扫描。\")]),s._v(\" \"),a(\"li\",[a(\"strong\",[s._v(\"容器别迷信“我删了就干净”\")]),s._v(\"：最稳的姿势仍然是\"),a(\"strong\",[s._v(\"隔离 + 重建\")]),s._v(\"，并把同宿主其他容器顺带做一遍快速核对。\")])]),s._v(\" \"),a(\"p\",[s._v(\"行了，该升级的升级、该轮转的轮转、该封的封。希望大家的服务器永远只有业务流量，没有挖矿进程。\")])])}),[],!1,null,null,null);t.default=e.exports}}]);","extractedComments":[]}